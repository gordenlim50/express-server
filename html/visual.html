<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Light Spectrum</title>
    <!-- Link To CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- Box Icons -->
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
</head>
<body>
    <!-- Header -->
    <header>
        <div class="nav container">
            <!-- Menu Icon -->
            <div class="bulb-icon">
                <i class='bx bx-bulb' id="bulb-icon"></i>
            </div>
            
            <!-- Logo -->
            <div class = "log">
                <ul>
                    <li><a class="logo">Intelligent Lighting Laboratory</a></li>
                </ul>
            </div>
        </div> 
    </header>
    <section id="ovrflw" class="backgrd">
        <div class = "vm">
            <h1>Visual Metrics:</h1>
        </div>
        
        <div class = "CCT">
            <h1>Corelated Colour Temperature (CCT)</h1>
            <p>(Suggested range: 2500K - 6500K)</p>
            <input type="text" name ="get_cct", id="get_cct", class="input-field-cct", placeholder="Set Desired CCT", min="2500", max="6000" > 
            <button id="set-button-cct" class="set-button-cct">Set</button>
        </div>

        <div class = "Plux">
            <h1>Photopic Illuminance (Plux)</h1>
            <p>(Suggested range: 0lux - 250lux)</p>
            <input type="text" name="get_plux", id="get_plux", class="input-field-plux", placeholder="Set Desired Plux",min="50", max="250" > 
            <button id="set-button-plux" class="set-button-plux">Set</button>     
        </div>

        <div class = "CRI">
            <h1>Colour Rendering Index (CRI)</h1>
            <p>(Suggested range: 0-100)</p>
            <input type = "text" name = "get_cri", id = "get_cri", class = "input-field-cri", placeholder="Set Desired CRI", min="0", max="100"> 
            <button id="set-button-cri" class="set-button-cri">Set</button>            
        </div>
        
        <div class ="back">
            <a href="/metrics" class="back-btn"> Back </a> 
        </div>
        <div class ="cover">
            <h1>Illuminating Life Intelligently</h1>
            <p>We aim to fulfill all the choices and preferences of our customers.</p>
            <img src="/image/blue-hourglass.gif" alt="name" class="glasshour"/> 
            <img src="/image/logo.png" alt="uni_logo" class="uni_logo"/>    
        </div>
        <div class = "vl"></div>
        <div class ="clear">
            <button id="clearbutton" class="clearbutton">Clear Results</button>
        </div>
        
        <div class ="target-content">
            <h1>Target Metrics</h1>
            <p id="inputDisplay"> </p>
        </div>
        <div class = "close-loop">
            <h1> Close-Loop P Control:</h1>  
        </div>
        <label class="switch">
            <input id="toggle" type="checkbox">
            <span class="slider round"></span>
        </label>

        <div class = "result-content" >
            <h1>Measured Metrics Results:</h1>
            <div id="result-box" class="result-box"></div>
        </div>
        <div class= "plot" id='myDiv'></div>
        <div class = "energy-content" >
            <h1> Estimated Energy Usage </h1>
            <div id="result-box2" class="result-box2"> </div>
        </div>
        <div class = "occupancy" >
            <h1> Occupancy Status </h1>
            <div class = "result-box3">
                <div class="Presence"> Presence: </div>
                <div class="Detected"> Person Detected: </div>
            </div>
        </div>

        <script>
            // Button Constant
            const cctButton = document.getElementById('set-button-cct');
            const pluxButton = document.getElementById('set-button-plux');
            const criButton = document.getElementById('set-button-cri');
            const clearButton = document.getElementById('clearbutton');
            const closeloopctrl = document.getElementById('toggle');

            // Input Constant of Visual metrics
            const inputCCT = document.getElementById('get_cct');
            const inputPlux = document.getElementById('get_plux');
            const inputCRI = document.getElementById('get_cri');

            // Result Boxes Constant
            const dataResult = document.getElementById('result-box');
            const dataResult2 = document.getElementById('result-box2');
            
            // Display Constant
            const sliderInput = document.querySelector('.switch input');
            const glasshourGif = document.querySelector('.glasshour');
            const covering = document.querySelector('.cover');
            const close_loop = document.querySelector('.close-loop');
            const toggle_switch = document.querySelector('.switch');

            
            // Create SPD plot
            function createPlot(yValues) {
            var SPM_return = {
                x: [380, 385, 390, 395, 400, 405, 410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 
                460, 465, 470, 475, 480, 485, 490, 495, 500, 505, 510, 515, 520, 525, 530, 535, 540, 
                545, 550, 555, 560, 565, 570, 575, 580, 585, 590, 595, 600, 605, 610, 615, 620, 625, 
                630, 635, 640, 645, 650, 655, 660, 665, 670, 675, 680, 685, 690, 695, 700, 705, 710, 
                715, 720, 725, 730, 735, 740, 745, 750, 755, 760, 765, 770, 775, 780],
                y: yValues,
                type: 'scatter',
                fill: 'tozeroy',
                fillcolor: 'blue',
            };

            var data = [SPM_return];
            var layout = {
                height: 450,
                width: 550,
                margin: {
                t: 50,  // Top margin
                b: 60,  // Bottom margin
                l: 50,  // Left margin
                r: 20   // Right margin
                },
                title: {text: 'Plot of SPD', 
                font: {
                    size: 23, 
                    weight: 'bolder'
                }
                },
                xaxis: {
                title: 'Wavelength (nm)',
                titlefont: {size: 12},
                tickfont: { size: 10}
                },
                yaxis: {
                title: 'Spectral Power Density (mW/m^2/nm)',
                titlefont: {size: 12},
                tickfont: { size: 10}
                }
            };

            Plotly.newPlot('myDiv', data, layout);
            }
        
            // Assuming you have a function to update the results on the HTML page
            function updateResults(results, buttonClicked) {
            const cctColor = buttonClicked === 'cct' ? 'rgba(11, 73, 241, 0.615); font-weight: bold;' : 'white';
            const pluxColor = buttonClicked === 'plux' ? 'rgba(11, 73, 241, 0.615); font-weight: bold;' : 'white';
            const criColor = buttonClicked === 'cri' ? 'rgba(11, 73, 241, 0.615); font-weight: bold ' : 'white';

            dataResult.innerHTML = `
                <p> CCT: <span style="color: ${cctColor}"> ${results['Measured CCT']} K</span></p>
                <p> Plux: <span style="color: ${pluxColor}">${results['Measured plux']} lux</span></p>
                <p> CRI: <span style="color: ${criColor}"> ${results['Measured CRI']}</span></p> 
                <p> MEDI: ${results['Measured medi']} lux</p>
                <p> MDER: ${results['Measured mder']}</p>
            `;

            dataResult2.innerHTML = `
                <p> LER: ${results['Measured LER']} lm/W</p>
                <p> Lumen: ${results['Measured Lumen']} lm</p>
                <p> Watt: ${results['Measured Watt']} W <p>
            `;

            createPlot(results['SPM_interpolated']);

            }

            function cctInputDisplay(cct) {
                const inputDisplay = document.getElementById('inputDisplay');
                inputDisplay.innerHTML = `Target CCT: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${cct} K </span>`;
            }

            function pluxInputDisplay(plux) {
                const inputDisplay = document.getElementById('inputDisplay');
                inputDisplay.innerHTML = `Target Plux: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${plux} lux </span>`;
            }

            function criInputDisplay(cri) {
                const inputDisplay = document.getElementById('inputDisplay');
                inputDisplay.innerHTML = `Target CRI: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${cri} </span>`;
            }

            clearButton.addEventListener('click', async () => {
                sliderInput.checked = false;
                glasshourGif.style.display = 'none';
                covering.style.display = 'flex';
                close_loop.style.display = 'none';
                toggle_switch.style.display = 'none';
                inputCCT.value = '';
                inputPlux.value = '';
                inputCRI.value = '';
            });

            cctButton.addEventListener('click', async () => {
              glasshourGif.style.display = 'block';
              const response = await fetch('/getCCT_OL', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: inputCCT.value })
              });
              cctInputDisplay(inputCCT.value);
              const result = await response.json();
              updateResults(result.processedData, 'cct');  
              covering.style.display = 'none';
              close_loop.style.display = 'block';
              toggle_switch.style.display = 'block';
            });

            pluxButton.addEventListener('click', async () => {
                glasshourGif.style.display = 'block';
                const response = await fetch('/getPlux_OL', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: inputPlux.value })
              });
              pluxInputDisplay(inputPlux.value);
              const result = await response.json();
              updateResults(result.processedData, 'plux');
              covering.style.display = 'none'; 
              close_loop.style.display = 'block';
              toggle_switch.style.display = 'block';
            });

            criButton.addEventListener('click', async () => {
                glasshourGif.style.display = 'block';
                const response = await fetch('/getCRI', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: inputCRI.value })
              });
              criInputDisplay(inputCRI.value);
              const result = await response.json();
              updateResults(result.processedData, 'cri'); 
              covering.style.display = 'none';
              close_loop.style.display = 'block';
              toggle_switch.style.display = 'block'; 
            });

            
            closeloopctrl.addEventListener('click', async () =>{
                if(inputCCT.value !== ""){
                    covering.style.display = 'flex';
                    glasshourGif.style.display = 'block';
                    const response = await fetch('/getCCT_CL', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: inputCCT.value })
                    });
                    cctInputDisplay(inputCCT.value);
                    const result = await response.json();
                    updateResults(result.processedData, 'cct');  
                    covering.style.display = 'none';

                } else if(inputPlux.value !== ""){
                    covering.style.display = 'flex';
                    glasshourGif.style.display = 'block';
                    const response = await fetch('/getPlux_CL', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: inputPlux.value })
                    });
                    pluxInputDisplay(inputPlux.value);
                    const result = await response.json();
                    updateResults(result.processedData, 'plux');
                    covering.style.display = 'none';

                } else if(inputCRI.value !== ""){
                    covering.style.display = 'flex';
                    glasshourGif.style.display = 'block';
                    const response = await fetch('/getCRI_CL', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: inputCRI.value })
                    });
                    criInputDisplay(inputCRI.value);
                    const result = await response.json();
                    updateResults(result.processedData, 'cri'); 
                    covering.style.display = 'none';
                }
            })
                
        </script>

    </section>
    <!-- Link To JS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src='https://cdn.plot.ly/plotly-2.25.2.min.js'></script>
</body>
</html>