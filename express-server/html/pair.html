<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Light Spectrum</title>
    <!-- Link To CSS -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Box Icons -->
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
</head>
<body>
    <!-- Header -->
    <header>
        <div class="nav container">
            <!-- Menu Icon -->
            <div class="bulb-icon">
                <i class='bx bx-bulb' id="bulb-icon"></i>
            </div>
            
            <!-- Logo -->
            <div class = "log">
                <ul>
                    <li><a class="logo">Intelligent Lighting Laboratory</a></li>
                </ul>
            </div>
        </div> 
    </header>
    <section id="ovrflw" class="backgrd">
        <div class = "comb">
            <h1>Pair Metrics:</h1>
        </div>
    
        <div class = "CCT_Plux">
            <h1>CCT & Photopic lux</h1>
            <p>(Suggested CCT range: 2500K - 6500K)<br>(Suggested Plux range: 0lux - 250lux)</p>
            <input type="text" name = "get_cct_plux", id = "get_cct_plux", class = "input-field-cct-plux", placeholder="Set Desired CCT", min="2500", max="6500"> 
            <button id="set-button-cct-plux" class="set-button-cct-plux">Set</button> 
            <input type="text" name = "get_plux_cct", id = "get_plux_cct", class = "input-field-plux-cct", placeholder="Set Desired Plux", min="0", max="250">   
        </div>
    
        <div class = "CCT_MEDI">
            <h1>CCT & MEDI</h1>
            <p>(Suggested CCT range: 2500K - 6500K)<br> (Suggested MEDI range: 0lux - 200lux)</p>
            <input type="text" name = "get_cct_medi", id = "get_cct_medi", class = "input-field-cct-medi", placeholder="Set Desired CCT", min="2500", max="6500"> 
            <button id="set-button-cct-medi" class="set-button-cct-medi">Set</button> 
            <input type="text" name = "get_medi_cct", id = "get_medi_cct", class = "input-field-medi-cct", placeholder="Set Desired MEDI", min="0", max ="200" >  
        </div>
        
        <div class = "Plux_MEDI">
            <h1>Plux & MEDI</h1>
            <p>(Suggested Plux range: 0lux - 250lux)<br> (Suggested MEDI range: 0lux - 200lux)</p>
            <input type="text" name = "get_plux_medi", id = "get_plux_medi", class = "input-field-plux-medi", placeholder="Set Desired Plux", min="0", max="250"> 
            <button id="set-button-plux-medi" class="set-button-plux-medi">Set</button> 
            <input type="text" name = "get_medi_plux", id = "get_medi_plux", class = "input-field-medi-plux", placeholder="Set Desired MEDI", min="0", max ="200" >  
        </div>

        
        <div class ="back">
            <a href="/metrics" class="back-btn"> Back </a> 
        </div>
        <div class ="cover">
            <h1>Illuminating Life Intelligently</h1>
            <p>We aim to fulfill all the choices and preferences of our customers.</p>
            <img src="/image/blue-hourglass.gif" alt="name" class="glasshour"/> 
            <img src="/image/logo.png" alt="uni_logo" class="uni_logo"/>  
        </div>
        <div class = "vl"></div>
        <div class ="clear">
            <button id="clearbutton" class="clearbutton">Clear Results</button>
        </div>

        <div class ="target-content">
            <h1>Target Metrics</h1>
            <p id="inputDisplay"> </p>
        </div>
        <div class = "close-loop">
            <h1> Close-Loop P Control:</h1>  
        </div>
        <label class="switch">
            <input id="toggle" type="checkbox">
            <span class="slider round"></span>
        </label>

        <div class = "result-content" >
            <h1>Measured Results:</h1>
            <div id="result-box" class="result-box"></div>
        </div>
        <div class= "plot" id='myDiv'></div>
        <div class = "energy-content" >
            <h1> Estimated Energy Usage </h1>
            <div id="result-box2" class="result-box2"> </div>
        </div>
        <div class = "occupancy" >
            <h1> Occupancy Status </h1>
            <div class = "result-box3">
                <div class="Presence"> Presence: </div>
                <div class="Detected"> Person Detected: </div>
            </div>
        </div>

        <script>
            // Button Constant
            const cct_pluxButton = document.getElementById('set-button-cct-plux');
            const cct_mediButton = document.getElementById('set-button-cct-medi');
            const plux_mediButton = document.getElementById('set-button-plux-medi');
            const clearButton = document.getElementById('clearbutton');
            const closeloopctrl = document.getElementById('toggle');

            // Input Constant of Visual metrics
            const inputCCT_cp = document.getElementById('get_cct_plux');
            const inputPlux_cp = document.getElementById('get_plux_cct');
            const inputCCT_cm = document.getElementById('get_cct_medi');
            const inputMedi_cm = document.getElementById('get_medi_cct');
            const inputPlux_pm = document.getElementById('get_plux_medi');
            const inputMedi_pm = document.getElementById('get_medi_plux');
            
            // Result Boxes Constant
            const dataResult = document.getElementById('result-box');
            const dataResult2 = document.getElementById('result-box2');

            // Display constant
            const sliderInput = document.querySelector('.switch input');
            const glasshourGif = document.querySelector('.glasshour');
            const covering = document.querySelector('.cover');
            const close_loop = document.querySelector('.close-loop');
            const toggle_switch = document.querySelector('.switch');

            // Create SPD plot
            function createPlot(yValues) {
            var SPM_return = {
                x: [380, 385, 390, 395, 400, 405, 410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 
                460, 465, 470, 475, 480, 485, 490, 495, 500, 505, 510, 515, 520, 525, 530, 535, 540, 
                545, 550, 555, 560, 565, 570, 575, 580, 585, 590, 595, 600, 605, 610, 615, 620, 625, 
                630, 635, 640, 645, 650, 655, 660, 665, 670, 675, 680, 685, 690, 695, 700, 705, 710, 
                715, 720, 725, 730, 735, 740, 745, 750, 755, 760, 765, 770, 775, 780],
                y: yValues,
                type: 'scatter'
            };

            var data = [SPM_return];
            var layout = {
                height: 400,
                width: 500,
                margin: {
                t: 50,  // Top margin
                b: 60,  // Bottom margin
                l: 50,  // Left margin
                r: 20   // Right margin
                },
                title: {text: 'Plot of SPD', 
                font: {
                    size: 23, 
                    weight: 'bolder'
                }
                },
                xaxis: {
                title: 'Wavelength (nm)',
                titlefont: {size: 12},
                tickfont: { size: 10}
                },
                yaxis: {
                title: 'Spectral Power Density (mW/m^2/nm)',
                titlefont: {size: 12},
                tickfont: { size: 10}
                }
            };

            Plotly.newPlot('myDiv', data, layout);
            }
        
            // Assuming you have a function to update the results on the HTML page
            function updateResults(results, buttonClicked) {
            const cctColor = (buttonClicked === 'cct_plux' || buttonClicked === 'cct_medi') ? 'rgba(11, 73, 241, 0.615); font-weight: bold;' : 'white';
            const mediColor = (buttonClicked === 'cct_medi' || buttonClicked === 'plux_medi') ? 'rgba(11, 73, 241, 0.615); font-weight: bold;' : 'white';
            const pluxColor = (buttonClicked === 'plux_medi' || buttonClicked === 'cct_plux') ? 'rgba(11, 73, 241, 0.615); font-weight: bold ' : 'white';

            dataResult.innerHTML = `
                <p> CCT: <span style="color: ${cctColor}"> ${results['Measured CCT']} K </span></p>
                <p> Plux: <span style="color: ${pluxColor}"> ${results['Measured plux']} lux </span></p>
                <p> CRI: ${results['Measured CRI']}</p> 
                <p> MEDI: <span style="color: ${mediColor}"> ${results['Measured medi']} lux </span></p>
                <p> MDER: ${results['Measured mder']}</p>
            `;

            dataResult2.innerHTML = `
                <p> LER: ${results['Measured LER']} lm/W</p>
                <p> Lumen: ${results['Measured Lumen']} lm</p>
            `;

            createPlot(results['SPM_interpolated']);

            }

            function cct_pluxInputDisplay(cct, plux) {
                const inputDisplay = document.getElementById('inputDisplay');
                inputDisplay.innerHTML = `Target CCT: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${cct} K </span>, 
                Target Plux: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${plux} lux </span>  `;
            }

            function cct_mediInputDisplay(cct, medi) {
                const inputDisplay = document.getElementById('inputDisplay');
                inputDisplay.innerHTML = `Target CCT: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${cct} lux </span>, 
                Target Medi: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${medi} lux </span>  `;
            }

            function plux_mediInputDisplay(plux, medi) {
                const inputDisplay = document.getElementById('inputDisplay');
                inputDisplay.innerHTML = `Target Plux: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${plux} lux </span>,
                Target Medi: <span style="color: rgba(11, 73, 241, 0.615); font-weight: bold;"> ${medi} lux </span>  `;
            }

            clearButton.addEventListener('click', async () => {
                sliderInput.checked = false;
                glasshourGif.style.display = 'none';
                covering.style.display = 'flex';
                close_loop.style.display = 'none';
                toggle_switch.style.display = 'none';
                inputCCT_cp.value = ''; 
                inputPlux_cp.value = '';
            });

            cct_pluxButton.addEventListener('click', async () => {
                glasshourGif.style.display = 'block';
                const requestData = {
                    inputcct: inputCCT_cp.value,
                    inputplux: inputPlux_cp.value
                };

                const response = await fetch('/get_CCT_Plux_OL', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
              });
              cct_pluxInputDisplay(inputCCT_cp.value, inputPlux_cp.value)
              const result = await response.json();
              updateResults(result.processedData, 'cct_plux'); 
              covering.style.display = 'none';
              close_loop.style.display = 'block';
              toggle_switch.style.display = 'block';
            });

            closeloopctrl.addEventListener('click', async ()=>{
                covering.style.display = 'flex';
                glasshourGif.style.display = 'block';
                const requestData = {
                    inputcct: inputCCT_cp.value,
                    inputplux: inputPlux_cp.value
                };
                const response = await fetch('/get_CCT_Plux_CL', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
             });
             cct_pluxInputDisplay(inputCCT_cp.value, inputPlux_cp.value)
             const result = await response.json();
             updateResults(result.processedData, 'cct_plux'); 
             covering.style.display = 'none';
            });


            cct_mediButton.addEventListener('click', async () => {
                glasshourGif.style.display = 'block';
                const requestData = {
                    inputcct: inputCCT_cm.value,
                    inputmedi: inputMedi_cm.value
                };
                
                const response = await fetch('/get_CCT_MEDI', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
              });
              cct_mediInputDisplay(inputCCT_cm.value, inputMedi_cm.value)
              const result = await response.json();
              updateResults(result.processedData, 'cct_medi'); 
              covering.style.display = 'none';
              
              inputCCT_cm.value = ''; 
              inputMedi_cm.value = ''; 
            });

            plux_mediButton.addEventListener('click', async () => {
                glasshourGif.style.display = 'block';
                const requestData = {
                    inputplux: inputPlux_pm.value,
                    inputmedi: inputMedi_pm.value
                };

                const response = await fetch('/get_Plux_MEDI', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
              });
              plux_mediInputDisplay(inputPlux_pm.value, inputMedi_pm.value)
              const result = await response.json();
              updateResults(result.processedData, 'plux_medi');  
              covering.style.display = 'none';
              inputPlux_pm.value = ''; 
              inputMedi_pm.value = ''; 
            });
        </script>


    </section>
    <!-- Link To JS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src='https://cdn.plot.ly/plotly-2.25.2.min.js'></script> 
</body>
</html>